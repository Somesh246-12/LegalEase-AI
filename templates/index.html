<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalEase AI - Demystify Legal Documents</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header class="main-header">
        <div class="container">
            <a href="/" class="logo">
                <img src="{{ url_for('static', filename='favicon.png') }}" alt="LegalEase AI Logo">
                Legal<span>Ease</span> AI
            </a>

            <nav class="main-nav">
                <a href="#" id="why-legalease-btn">Why LegalEase?</a>
            </nav>
        </div>
    </header>
    <main>
        <section class="hero">
            <div class="container">
                <h1>Demystify Legal Jargon with AI ‚ú®</h1>
                <p>Paste your text or upload a document, and let our AI provide clear, simple explanations in seconds.
                    Understand your contracts with confidence.</p>
                <form method="post" enctype="multipart/form-data" id="upload-form">
                    <div class="input-tabs">
                        <button type="button" class="tab-button active" data-tab="upload-panel">Upload File</button>
                        <button type="button" class="tab-button" data-tab="paste-panel">Paste Text</button>
                    </div>
                    <div id="upload-panel" class="input-panel active">
                        <input type="file" name="pdf_file" id="file-input" class="hidden"
                            accept=".pdf,.txt,.md,.jpg,.jpeg,.png">
                        <div class="upload-area" id="upload-box">
                            <div class="upload-icon">üìÑ</div>
                            <h3>Drag & Drop Your File Here</h3>
                            <p class="text-secondary">or click to select a file (PDF, TXT, JPG, PNG)</p>
                        </div>
                    </div>
                    <div id="paste-panel" class="input-panel">
                        <textarea name="legal_text" class="upload-area"
                            placeholder="Paste your legal text here..."></textarea>
                    </div>

                    <div class="language-selector-wrapper">
                        <label for="target_language">Select Output Language:</label>
                        <select name="target_language" id="target_language">
                            <option value="English">English</option>
                            <option value="Spanish">Espa√±ol (Spanish)</option>
                            <option value="French">Fran√ßais (French)</option>
                            <option value="German">Deutsch (German)</option>
                            <option value="Hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                            <option value="Marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-cta">Simplify Document</button>
                </form>
            </div>
        </section>
        {% if result %}
        <section class="main-content container">
            <div id="document-context" style="display: none;">{{ original_text | safe }}</div>
            <div class="split-screen">
                <div class="text-pane simplified-pane">
                    <h2>Simplified Explanation</h2>
                    <div class="ai-result">{{ result | safe }}</div>
                </div>
                <!-- NEW: Risk Analysis Pane -->
                <div class="text-pane risk-pane">
                    <h2>Risk Analysis</h2>
                    <div class="risk-actions-top btn-group">
                        <button type="button" class="btn btn-primary btn-pill"
                            onclick="window.location.href='/export.csv'">
                            <span class="btn-icon">‚¨áÔ∏è</span>
                            <span>Export CSV</span>
                        </button>
                        <button type="button" class="btn btn-outline btn-pill"
                            onclick="window.location.href='/export.pdf'">
                            <span class="btn-icon">üñ®Ô∏è</span>
                            <span>Export PDF</span>
                        </button>
                    </div>
                    <div class="risk-legend">
                        <span class="legend-item risk-high">High</span>
                        <span class="legend-item risk-medium">Medium</span>
                        <span class="legend-item risk-low">Low</span>
                    </div>
                    <div class="risk-result">{{ risk_html | safe }}</div>
                    <div class="risk-charts two-col">
                        <div class="chart-card">
                            <h4>Risks by Severity</h4>
                            <canvas id="severityChart" height="90"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="main-footer">
                <p class="footer-copyright">&copy; 2025 LegalEase AI. Hackathon Project. <br> This is not legal advice.
                    Always consult a qualified professional.</p>
            </footer>
        </section>
        {% endif %}
    </main>

    <div class="chat-widget">
        <div class="chat-label" id="chat-label">
            Confused? Ask Mr.Ken
        </div>
        <button id="chat-toggle-button">
            <img src="{{ url_for('static', filename='adv.png') }}" alt="AI Chatbot Icon">
        </button>
        <div class="chat-window" id="chat-window">
            <div class="chat-header">
                <h3>Define your query</h3>
                <button id="chat-close-button">_</button>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="chat-message bot">
                    Hi! If you found any query in summary, type it below and I'll explain it.
                </div>
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" placeholder="Type your query...">
                <button id="chat-send-button">Send</button>
            </div>
        </div>
    </div>


    <!-- NEW: Documentation Modal -->
    <div id="docs-modal" class="modal" style="display:none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Why LegalEase AI Matters</h3>
                <button id="docs-close-btn">√ó</button>
            </div>
            <div class="modal-body docs-body">
                <h2>From Confusion to Clarity: Empowering You to Understand the Fine Print</h2>
                <p>Legal documents govern our lives‚Äîfrom the apartments we rent to the software we use. Yet, they are
                    often written in dense, intimidating language designed by lawyers, for lawyers. This creates a
                    significant power imbalance, leaving most people in the dark about the rights they're giving away
                    and the risks they're accepting.</p>

                <hr>

                <h3>The Danger of Jargon and the Power of Risk Analysis</h3>
                <p>Signing a contract you don't fully understand is a huge gamble. A single misunderstood clause can
                    lead to unexpected fees, loss of personal data, or severe limitations on your rights. LegalEase AI
                    tackles this head-on by not only translating jargon into simple language but by actively searching
                    for and flagging potential risks. Our AI categorizes these risks‚Äî<strong>
                        <font color="#f87171">High</font>
                    </strong>, <strong>
                        <font color="#facc15">Medium</font>
                    </strong>, and <strong>
                        <font color="#34d399">Low</font>
                    </strong>‚Äîso you can instantly see which parts of the document demand your full attention.</p>


                <hr>

                <h3>How LegalEase AI is Different</h3>
                <p>While other tools might offer basic summaries, LegalEase AI provides a deeper level of insight that
                    sets it apart:</p>
                <ul>
                    <li><strong>Proactive Risk Detection:</strong> We don't just tell you what the document says; we
                        tell you what it *means* for you.</li>
                    <li><strong>Multi-Format Intelligence:</strong> Whether it's a selectable PDF or a scanned image of
                        a paper contract, our powerful Document AI engine can read and analyze it.</li>
                    <li><strong>Interactive Learning:</strong> Our document-aware chatbot allows you to ask specific
                        questions about the text, turning a passive reading experience into an active conversation.</li>
                    <li><strong>Actionable Suggestions:</strong> For every risk identified, our AI provides practical
                        suggestions, empowering you to negotiate better terms with confidence.</li>
                </ul>

                <h3>Who This Helps</h3>
                <p>LegalEase AI is for anyone who has ever felt overwhelmed by a contract. It's for <strong>freelancers</strong>
                    reviewing client agreements, <strong>small business owners</strong> signing vendor contracts, <strong>tenants</strong>
                    navigating lease agreements, and every consumer who wants to be informed before they click "I
                    Agree." Our mission is to level the playing field and make legal understanding a right, not a
                    privilege.</p>
            </div>
        </div>
    </div>

    <script>
        const tabs = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.input-panel');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const panelId = tab.getAttribute('data-tab');
                document.getElementById(panelId).classList.add('active');
            });
        });
        const uploadBox = document.getElementById('upload-box');
        const fileInput = document.getElementById('file-input');
        if (uploadBox && fileInput) {
            uploadBox.addEventListener('click', () => { fileInput.click(); });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    uploadBox.querySelector('h3').textContent = fileInput.files[0].name;
                    uploadBox.querySelector('p').textContent = 'File selected. Ready to simplify!';
                }
            });
        }

        // --- Chatbot JavaScript ---
        const chatWindow = document.getElementById('chat-window');
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const chatCloseButton = document.getElementById('chat-close-button');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatBody = document.getElementById('chat-body');

        // Toggle chat window visibility (guarded)
        if (chatToggleButton && chatWindow) {
            chatToggleButton.addEventListener('click', () => {
                chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
            });
        }
        if (chatCloseButton && chatWindow) {
            chatCloseButton.addEventListener('click', () => {
                chatWindow.style.display = 'none';
            });
        }

        // Function to add a message to the chat body
        function addMessage(text, sender) {
            if (!chatBody) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = text;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight; // Auto-scroll to bottom
        }

        // Function to handle sending a message
        async function sendMessage() {
            const userInput = chatInput ? chatInput.value.trim() : '';
            if (userInput === '') return;

            addMessage(userInput, 'user');
            if (chatInput) chatInput.value = '';

            // NEW: Get the document context from the hidden div (guarded)
            const docCtxEl = document.getElementById('document-context');
            const documentContext = docCtxEl ? docCtxEl.textContent : '';

            const messages = chatBody ? Array.from(chatBody.querySelectorAll('.chat-message')).map(msg => ({
                role: msg.classList.contains('user') ? 'user' : 'model',
                text: msg.textContent,
            })) : [];

            // Send history AND document context to the backend
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: messages,
                        document_text: documentContext // NEW: Send document text
                    }),
                });
                const data = await response.json();
                addMessage(data.response, 'bot');
            } catch (error) {
                addMessage("Sorry, I couldn't get a response right now.", 'bot');
                console.error('Chat error:', error);
            }
        }

        // Charts + Rewrite wiring
        async function loadRiskData() {
            try {
                const res = await fetch('/risks.json');
                const data = await res.json();
                const stats = data.stats || { severity: {}, type: {} };
                const sev = stats.severity || {};
                const sevCtx = document.getElementById('severityChart');
                if (sevCtx) {
                    const donut = new Chart(sevCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['High', 'Medium', 'Low'],
                            datasets: [{
                                data: [sev.high || 0, sev.medium || 0, sev.low || 0],
                                backgroundColor: ['#ff6b6b', '#ffd166', '#06d6a0'],
                                hoverOffset: 6,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            cutout: '60%',
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
            } catch (e) {
                console.error('Charts error', e);
            }
        }

        async function requestRewrite(clause, mode) {
            const languageSel = document.getElementById('target_language');
            const language = languageSel ? languageSel.value : 'English';
            const res = await fetch('/rewrite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clause, mode, language })
            });
            const data = await res.json();
            return data.rewrite || 'No rewrite available.';
        }

        function bindRewriteButtons() {
            const modal = document.getElementById('rewrite-modal');
            const out = document.getElementById('rewrite-output');
            const closeBtn = document.getElementById('rewrite-close');
            if (closeBtn && modal) closeBtn.onclick = () => { modal.style.display = 'none'; };
            document.body.addEventListener('click', async (e) => {
                const btn = e.target.closest('.rewrite-btn');
                if (!btn) return;
                const clause = btn.getAttribute('data-clause') || '';
                const selectedMode = document.querySelector('input[name="rewrite-mode"]:checked');
                const mode = selectedMode ? selectedMode.value : 'plain';
                modal.style.display = 'block';
                out.textContent = 'Generating safer rewrite...';
                try {
                    const rewrite = await requestRewrite(clause, mode);
                    out.textContent = rewrite;
                } catch (err) {
                    out.textContent = 'Failed to generate rewrite.';
                }
            });
        }

        function simplifyRiskLanguage() {
            const MAX = 160;
            const ellipsis = chr => (chr.length > 0 ? '‚Ä¶' : '');
            document.querySelectorAll('.risk-item').forEach(item => {
                ['risk-issue', 'risk-suggestion'].forEach(cls => {
                    const el = item.querySelector(`.${cls}`);
                    if (!el) return;
                    const strong = el.querySelector('b');
                    const label = strong ? strong.outerHTML : '';
                    const text = el.innerText.replace(/^.*?:\s*/, '');
                    if (text.length > MAX) {
                        const short = text.slice(0, MAX);
                        const more = document.createElement('a');
                        more.href = '#';
                        more.className = 'more-link';
                        more.textContent = ' More';
                        const span = document.createElement('span');
                        span.textContent = short + '‚Ä¶';
                        el.innerHTML = label;
                        el.appendChild(span);
                        el.appendChild(more);
                        more.addEventListener('click', (evt) => {
                            evt.preventDefault();
                            el.innerHTML = label + text;
                        });
                    }
                });
            });
        }

        // Initialize when result present (template-driven boolean via string)
        const hasResult = "{{ '1' if result else '0' }}";
        if (hasResult === '1') {
            loadRiskData();
            bindRewriteButtons();
            simplifyRiskLanguage();
        }
        if (chatSendButton) {
            chatSendButton.addEventListener('click', sendMessage);
        }
        // Allow sending by pressing Enter
        if (chatInput) {
            chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // --- Documentation Modal JavaScript ---
        const docsModal = document.getElementById('docs-modal');
        const whyLegaleaseBtn = document.getElementById('why-legalease-btn');
        const docsCloseBtn = document.getElementById('docs-close-btn');

        if (whyLegaleaseBtn) {
            whyLegaleaseBtn.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent page from jumping to top
                if (docsModal) docsModal.style.display = 'flex';
            });
        }

        if (docsCloseBtn) {
            docsCloseBtn.addEventListener('click', () => {
                if (docsModal) docsModal.style.display = 'none';
            });
        }
    </script>
</body>

</html>
