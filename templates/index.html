<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalEase AI - Demystify Legal Documents</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <header class="main-header">
        <div class="container">
            <a href="/" class="logo">
                <img src="{{ url_for('static', filename='favicon.png') }}" alt="LegalEase AI Logo">
                Legal<span>Ease</span> AI
            </a>
        </div>
    </header>
    <main>
        <section class="hero">
            <div class="container">
                <h1>Demystify Legal Jargon with AI ‚ú®</h1>
                <p>Paste your text or upload a document, and let our AI provide clear, simple explanations in seconds.
                    Understand your contracts with confidence.</p>
                <form method="post" enctype="multipart/form-data" id="upload-form">
                    <div class="input-tabs">
                        <button type="button" class="tab-button active" data-tab="upload-panel">Upload File</button>
                        <button type="button" class="tab-button" data-tab="paste-panel">Paste Text</button>
                    </div>
                    <div id="upload-panel" class="input-panel active">
                        <input type="file" name="pdf_file" id="file-input" class="hidden"
                            accept=".pdf,.txt,.md,.jpg,.jpeg,.png">
                        <div class="upload-area" id="upload-box">
                            <div class="upload-icon">üìÑ</div>
                            <h3>Drag & Drop Your File Here</h3>
                            <p class="text-secondary">or click to select a file (PDF, TXT, JPG, PNG)</p>
                        </div>
                    </div>
                    <div id="paste-panel" class="input-panel">
                        <textarea name="legal_text" class="upload-area"
                            placeholder="Paste your legal text here..."></textarea>
                    </div>

                    <div class="language-selector-wrapper">
                        <label for="target_language">Select Output Language:</label>
                        <select name="target_language" id="target_language">
                            <option value="English">English</option>
                            <option value="Spanish">Espa√±ol (Spanish)</option>
                            <option value="French">Fran√ßais (French)</option>
                            <option value="German">Deutsch (German)</option>
                            <option value="Hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                            <option value="Marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-cta">Simplify Document</button>
                </form>
            </div>
        </section>
        {% if result %}
        <section class="main-content container">
            <div id="document-context" style="display: none;">{{ original_text | safe }}</div>
            <div class="split-screen">
                <div class="text-pane simplified-pane">
                    <h2>Simplified Explanation</h2>
                    <div class="ai-result">{{ result | safe }}</div>
                </div>
                <!-- NEW: Risk Analysis Pane -->
                <div class="text-pane risk-pane">
                    <h2>Risk Analysis</h2>
                    <div class="risk-legend">
                        <span class="legend-item risk-high">High</span>
                        <span class="legend-item risk-medium">Medium</span>
                        <span class="legend-item risk-low">Low</span>
                    </div>
                    <div class="risk-result">{{ risk_html | safe }}</div>
                </div>
            </div>
            <footer class="main-footer">
                <p class="footer-copyright">&copy; 2025 LegalEase AI. Hackathon Project. <br> This is not legal advice.
                    Always consult a qualified professional.</p>
            </footer>
        </section>
        {% endif %}
    </main>

    <div class="chat-widget">
        <div class="chat-label" id="chat-label">
            Confused? Ask Mr.Ken
        </div>
        <button id="chat-toggle-button">
            <img src="{{ url_for('static', filename='adv.png') }}" alt="AI Chatbot Icon">
        </button>
        <div class="chat-window" id="chat-window">
            <div class="chat-header">
                <h3>Define your query</h3>
                <button id="chat-close-button">_</button>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="chat-message bot">
                    Hi! If you found any query in summary, type it below and I'll explain it.
                </div>
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" placeholder="Type your query...">
                <button id="chat-send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        const tabs = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.input-panel');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const panelId = tab.getAttribute('data-tab');
                document.getElementById(panelId).classList.add('active');
            });
        });
        const uploadBox = document.getElementById('upload-box');
        const fileInput = document.getElementById('file-input');
        if (uploadBox && fileInput) {
            uploadBox.addEventListener('click', () => { fileInput.click(); });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    uploadBox.querySelector('h3').textContent = fileInput.files[0].name;
                    uploadBox.querySelector('p').textContent = 'File selected. Ready to simplify!';
                }
            });
        }

        // --- Chatbot JavaScript ---
        const chatWindow = document.getElementById('chat-window');
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const chatCloseButton = document.getElementById('chat-close-button');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatBody = document.getElementById('chat-body');

        // Toggle chat window visibility (guarded)
        if (chatToggleButton && chatWindow) {
            chatToggleButton.addEventListener('click', () => {
                chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
            });
        }
        if (chatCloseButton && chatWindow) {
            chatCloseButton.addEventListener('click', () => {
                chatWindow.style.display = 'none';
            });
        }

        // Function to add a message to the chat body
        function addMessage(text, sender) {
            if (!chatBody) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.textContent = text;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight; // Auto-scroll to bottom
        }

        // Function to handle sending a message
        async function sendMessage() {
            const userInput = chatInput ? chatInput.value.trim() : '';
            if (userInput === '') return;

            addMessage(userInput, 'user');
            if (chatInput) chatInput.value = '';

            // NEW: Get the document context from the hidden div (guarded)
            const docCtxEl = document.getElementById('document-context');
            const documentContext = docCtxEl ? docCtxEl.textContent : '';

            const messages = chatBody ? Array.from(chatBody.querySelectorAll('.chat-message')).map(msg => ({
                role: msg.classList.contains('user') ? 'user' : 'model',
                text: msg.textContent,
            })) : [];

            // Send history AND document context to the backend
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: messages,
                        document_text: documentContext // NEW: Send document text
                    }),
                });
                const data = await response.json();
                addMessage(data.response, 'bot');
            } catch (error) {
                addMessage("Sorry, I couldn't get a response right now.", 'bot');
                console.error('Chat error:', error);
            }
        }
        if (chatSendButton) {
            chatSendButton.addEventListener('click', sendMessage);
        }
        // Allow sending by pressing Enter
        if (chatInput) {
            chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        }
    </script>
</body>

</html>